{% extends 'base.html' %}
{% block content %}
<div class="container py-4">
  <h1 class="mb-4"><i class="fas fa-brain me-2"></i>Smart Ventilation Control</h1>

  <!-- Choix du modÃ¨le -->
  <div class="mb-4">
    <label for="modelSelect" class="form-label fs-5">Choose ML model:</label>
    <select class="form-select w-auto" id="modelSelect">
      <option selected disabled>Loading models...</option>
    </select>
  </div>

  <!-- Capteurs & PrÃ©diction -->
  <div class="row g-4">
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-header bg-info text-white">
          <i class="fas fa-thermometer-half me-2"></i>Sensor Readings
        </div>
        <div class="card-body">
          <ul class="list-group list-group-flush fs-5">
            <li class="list-group-item">ğŸŒ¡ï¸ Temperature: <span id="val-temp">--</span> Â°C</li>
            <li class="list-group-item">ğŸ’§ Humidity: <span id="val-humidity">--</span> %</li>
            <li class="list-group-item">âš¡ Current: <span id="val-current">--</span> mA</li>
            <li class="list-group-item">ğŸŒ¬ï¸ Pressure: <span id="val-pressure">--</span> hPa</li>
            <li class="list-group-item">ğŸ”‹ Energy: <span id="val-energy">--</span> mWh</li>
            <li class="list-group-item">ğŸ§  Workload: <span id="val-workload">--</span></li>
          </ul>
        </div>
        <div class="card-footer small text-muted">
          Last update: <span class="live-time">Just now</span>
        </div>
      </div>
    </div>

    <!-- PrÃ©diction -->
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-header bg-primary text-white">
          <i class="fas fa-fan me-2"></i>ML Prediction
        </div>
        <div class="card-body d-flex flex-column justify-content-center align-items-center">
          <h3 class="text-center mb-3">Recommended Ventilation Intensity</h3>
          <div id="prediction-output" class="display-4 text-success text-center">
            --
          </div>
          <div id="prediction-confidence" class="text-muted mt-3">
            Confidence: --
          </div>
        </div>
        <div class="card-footer small text-muted text-center">
          Updated every 10 seconds
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const MODEL_API_URL = 'http://localhost:8000/predict';

  // Initialise les modÃ¨les une fois que la premiÃ¨re rÃ©ponse est reÃ§ue
  async function fetchModelListOnce() {
    const simulated = simulateSensorData();
    const resp = await fetch(MODEL_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(simulated)
    });
    const models = Object.keys(await resp.json());
    const select = document.getElementById("modelSelect");
    select.innerHTML = ""; // Reset
    models.forEach(model => {
      const option = document.createElement("option");
      option.value = model;
      option.text = model;
      select.appendChild(option);
    });
    select.selectedIndex = 0;
  }

  function simulateSensorData() {
    return {
      temperature: +(20 + Math.random() * 10).toFixed(2),
      humidity: +(30 + Math.random() * 40).toFixed(2),
      current: +(0.5 + Math.random() * 4).toFixed(2),
      pressure: +(1000 + Math.random() * 30).toFixed(2),
      energy: +(1 + Math.random()*10).toFixed(2),
      workload: +(Math.random()*100).toFixed(2)
    };
  }

  async function updatePrediction() {
    const data = simulateSensorData();

    // Afficher les donnÃ©es simulÃ©es dans l'interface
    document.getElementById('val-temp').innerText = data.temperature;
    document.getElementById('val-humidity').innerText = data.humidity;
    document.getElementById('val-current').innerText = data.current;
    document.getElementById('val-pressure').innerText = data.pressure;
    document.getElementById('val-energy').innerText = data.energy;
    document.getElementById('val-workload').innerText = data.workload;

    try {
      const response = await fetch(MODEL_API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      const result = await response.json();

      const selectedModel = document.getElementById("modelSelect").value;
      const modelResult = result[selectedModel];

      document.getElementById('prediction-output').innerText =
  modelResult.prediction === 1 ? "ğŸŸ¢ Fan ON" : "ğŸ”´ Fan OFF";


      document.getElementById('prediction-confidence').innerText =
        modelResult.probability !== null
          ? "Intensity: " + (modelResult.probability * 100).toFixed(1) + "%"
          : "Model does not return intensity";

    } catch (err) {
      document.getElementById('prediction-output').innerText = "Error";
      document.getElementById('prediction-confidence').innerText = err;
    }
  }

  // Initialisation
  fetchModelListOnce().then(() => {
    updatePrediction();
    setInterval(updatePrediction, 1000);
  });
</script>
{% endblock %}
