{% extends 'base.html' %}
{% block content %}
<div class="container">
  <h1 class="mb-4"><i class="fas fa-users me-2"></i>Workload Simulator</h1>
  
  <div class="row g-4 mb-4">
    <!-- Simulation Controls -->
    <div class="col-md-5">
      <div class="card h-100">
        <div class="card-header bg-primary text-white">
          <i class="fas fa-tachometer-alt me-2"></i>Load Parameters
        </div>
        <div class="card-body">
          <form id="simulationForm">
            <div class="mb-3">
              <label class="form-label">Number of Users</label>
              <input type="number" class="form-control" id="userCount" min="1" max="1000" value="50">
            </div>
            <div class="mb-3">
              <label class="form-label">Posts per Minute</label>
              <input type="number" class="form-control" id="postRate" min="1" max="100" value="10">
            </div>
            <div class="mb-3">
              <label class="form-label">Post Length (chars)</label>
              <input type="number" class="form-control" id="postLength" min="10" max="500" value="120">
            </div>
            <div class="mb-3">
              <label class="form-label">Duration (minutes)</label>
              <input type="number" class="form-control" id="duration" min="1" max="60" value="5">
            </div>
            <div class="mb-3 form-check">
              <input type="checkbox" class="form-check-input" id="randomUsers" checked>
              <label class="form-check-label">Randomize user activity</label>
            </div>
            <div class="d-grid gap-2">
              <button type="button" class="btn btn-primary" id="startSimulation">
                <i class="fas fa-play me-2"></i>Start Simulation
              </button>
              <button type="button" class="btn btn-danger" id="stopSimulation" disabled>
                <i class="fas fa-stop me-2"></i>Stop Simulation
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Live Stats -->
    <div class="col-md-7">
      <div class="card h-100">
        <div class="card-header bg-success text-white">
          <i class="fas fa-chart-bar me-2"></i>Live Statistics
        </div>
        <div class="card-body">
          <div class="row text-center mb-3">
            <div class="col-md-4">
              <h5>Active Users</h5>
              <h2 id="activeUsers" class="text-primary">0</h2>
            </div>
            <div class="col-md-4">
              <h5>Posts/Min</h5>
              <h2 id="postsPerMin" class="text-info">0</h2>
            </div>
            <div class="col-md-4">
              <h5>Total Posts</h5>
              <h2 id="totalPosts" class="text-success">0</h2>
            </div>
          </div>
          <div class="chart-container" style="height: 200px;">
            <canvas id="loadChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- System Impact -->
  <div class="card mb-4">
    <div class="card-header bg-warning text-dark">
      <i class="fas fa-server me-2"></i>System Impact
    </div>
    <div class="card-body">
      <div class="row text-center">
        <div class="col-md-3">
          <h5>CPU Usage</h5>
          <div class="progress">
            <div id="cpuUsage" class="progress-bar bg-danger" role="progressbar" style="width: 0%">0%</div>
          </div>
        </div>
        <div class="col-md-3">
          <h5>Memory Usage</h5>
          <div class="progress">
            <div id="memUsage" class="progress-bar bg-info" role="progressbar" style="width: 0%">0%</div>
          </div>
        </div>
        <div class="col-md-3">
          <h5>Database Load</h5>
          <div class="progress">
            <div id="dbLoad" class="progress-bar bg-warning" role="progressbar" style="width: 0%">0%</div>
          </div>
        </div>
        <div class="col-md-3">
          <h5>Network Traffic</h5>
          <div class="progress">
            <div id="netTraffic" class="progress-bar bg-success" role="progressbar" style="width: 0%">0%</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Activity Feed -->
  <div class="card">
    <div class="card-header bg-dark text-white">
      <i class="fas fa-comments me-2"></i>Simulated Activity Feed
    </div>
    <div class="card-body p-0">
      <div id="activityFeed" style="height: 300px; overflow-y: auto;">
        <div class="list-group list-group-flush">
          <div class="list-group-item text-muted text-center py-5">
            Simulation will display live feed activity here
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    let simulationInterval;
    let simChart;
    const samplePosts = [
      "Just checked the energy stats - looking good!",
      "Our solar panels are generating 4.2kW right now",
      "Switched to battery power during peak hours",
      "The new ML model predictions are accurate",
      "Wind turbine output is lower than expected today",
      "Reduced server load by 15% with optimizations",
      "Data center temperature stable at 24Â°C",
      "Implemented new cooling strategy - working well",
      "Energy consumption trending downward this week",
      "The green meter shows excellent efficiency"
    ];

    // Initialize chart
    const ctx = document.getElementById('loadChart').getContext('2d');
    simChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: Array.from({length: 10}, (_, i) => i),
        datasets: [{
          label: 'Active Users',
          data: [],
          borderColor: 'rgba(13, 110, 253, 1)',
          backgroundColor: 'rgba(13, 110, 253, 0.1)',
          tension: 0.4
        }, {
          label: 'Posts/Min',
          data: [],
          borderColor: 'rgba(40, 167, 69, 1)',
          backgroundColor: 'rgba(40, 167, 69, 0.1)',
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: { beginAtZero: true }
        }
      }
    });

    // Stop simulation handler
    document.getElementById('stopSimulation').addEventListener('click', function() {
      clearInterval(simulationInterval);
      document.getElementById('startSimulation').disabled = false;
      document.getElementById('stopSimulation').disabled = true;
    });

    function updateSystemImpact(activeUsers, postsPerMin) {
      // Calculate system impact percentages
      const cpuUsage = Math.min(100, Math.floor(activeUsers * 0.2 + postsPerMin * 0.5));
      const memUsage = Math.min(100, Math.floor(activeUsers * 0.15 + postsPerMin * 0.3));
      const dbLoad = Math.min(100, Math.floor(activeUsers * 0.1 + postsPerMin * 0.7));
      const netTraffic = Math.min(100, Math.floor(activeUsers * 0.3 + postsPerMin * 0.4));

      // Update progress bars
      document.getElementById('cpuUsage').style.width = `${cpuUsage}%`;
      document.getElementById('cpuUsage').textContent = `${cpuUsage}%`;
      document.getElementById('memUsage').style.width = `${memUsage}%`;
      document.getElementById('memUsage').textContent = `${memUsage}%`;
      document.getElementById('dbLoad').style.width = `${dbLoad}%`;
      document.getElementById('dbLoad').textContent = `${dbLoad}%`;
      document.getElementById('netTraffic').style.width = `${netTraffic}%`;
      document.getElementById('netTraffic').textContent = `${netTraffic}%`;
    }

    function updateChartData(activeUsers, postsPerMin) {
      // Shift data left if we have more than 10 points
      if (simChart.data.labels.length >= 10) {
        simChart.data.labels.shift();
        simChart.data.datasets[0].data.shift();
        simChart.data.datasets[1].data.shift();
      }

      // Add new data point
      simChart.data.labels.push(simChart.data.labels.length);
      simChart.data.datasets[0].data.push(activeUsers);
      simChart.data.datasets[1].data.push(postsPerMin);

      // Update chart
      simChart.update();
    }

    function generateFeedActivity(postsPerMin, postLength) {
      const feedContainer = document.querySelector('#activityFeed .list-group-flush');
      
      // Generate sample posts
      for (let i = 0; i < postsPerMin; i++) {
        const randomPost = samplePosts[Math.floor(Math.random() * samplePosts.length)];
        const randomUser = `user${Math.floor(Math.random() * 1000)}`;
        
        const postElement = document.createElement('div');
        postElement.className = 'list-group-item';
        postElement.innerHTML = `
          <div class="d-flex w-100 justify-content-between">
            <h6 class="mb-1">${randomUser}</h6>
            <small class="text-muted">Just now</small>
          </div>
          <p class="mb-1">${randomPost}</p>
        `;
        
        feedContainer.prepend(postElement);
      }
    }

    // Start simulation
    document.getElementById('startSimulation').addEventListener('click', function() {
      const userCount = parseInt(document.getElementById('userCount').value);
      const postRate = parseInt(document.getElementById('postRate').value);
      const duration = parseInt(document.getElementById('duration').value);
      const postLength = parseInt(document.getElementById('postLength').value);
      const randomUsers = document.getElementById('randomUsers').checked;
      
      let totalPosts = 0;
      let activeUsers = 0;
      let postsPerMin = 0;
      let timeElapsed = 0;
      
      // Reset UI
      document.getElementById('startSimulation').disabled = true;
      document.getElementById('stopSimulation').disabled = false;
      document.getElementById('activityFeed').innerHTML = 
        '<div class="list-group list-group-flush"></div>';
      
      // Start simulation loop
      simulationInterval = setInterval(function() {
        timeElapsed++;
        
        // Update random active users
        activeUsers = randomUsers ? 
          Math.floor(userCount * (0.3 + Math.random() * 0.7)) : 
          userCount;
          
        // Generate posts
        postsPerMin = Math.floor(postRate * (0.5 + Math.random()));
        totalPosts += postsPerMin;
        
        // Update stats
        document.getElementById('activeUsers').textContent = activeUsers;
        document.getElementById('postsPerMin').textContent = postsPerMin;
        document.getElementById('totalPosts').textContent = totalPosts;
        
        // Update system impact
        updateSystemImpact(activeUsers, postsPerMin);
        
        // Update chart
        updateChartData(activeUsers, postsPerMin);
        
        // Generate feed activity
        generateFeedActivity(postsPerMin, postLength);
        
        // Check if simulation should end
        if (timeElapsed >= duration) {
          clearInterval(simulationInterval);
          document.getElementById('startSimulation').disabled = false;
          document.getElementById('stopSimulation').disabled = true;
        }
      }, 1000); // Update every second (1 minute = 60 seconds in simulation)
    });
  });
</script>
{% endblock %}
